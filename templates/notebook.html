<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studility Notebook</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        :root {
    --bg: #f4f4f9;
    --sidebar: #ffffff;
    --accent: #4a90e2;
    --text: #333;
}

body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
.container { max-width: 600px; margin: 0 auto; padding: 2rem; text-align: center; }
.center-screen { display: flex; flex-direction: column; justify-content: center; height: 100vh; }

/* Layout */
.app-layout { display: flex; height: 100vh; }
.sidebar { width: 300px; background: var(--sidebar); border-right: 1px solid #ddd; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; }
.main-content { flex: 1; display: flex; flex-direction: column; padding: 1rem; }

/* Components */
input, textarea, button { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
button { background: var(--accent); color: white; border: none; cursor: pointer; font-weight: bold; }
button:hover { opacity: 0.9; }

.source-item { background: #f0f0f0; padding: 8px; margin-bottom: 5px; border-radius: 4px; font-size: 0.9rem; }

/* Chat */
#chat-box { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 10px; }
.message { display: flex; }
.message.user { justify-content: flex-end; }
.message.ai { justify-content: flex-start; }
.bubble { max-width: 70%; padding: 10px 15px; border-radius: 15px; background: #e1e1e1; }
.message.user .bubble { background: var(--accent); color: white; }

.chat-input-area { display: flex; gap: 10px; padding-top: 10px; }

/* Modal */
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; }
.modal.hidden { display: none; }
.modal-content { background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow: auto; position: relative; }
.close { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; }

/* Util */
.success-box { background: #d4edda; color: #155724; padding: 20px; border-radius: 8px; border: 1px solid #c3e6cb; }
.pass { font-family: monospace; background: white; padding: 2px 5px; border: 1px solid #aaa; }
.warning { color: #856404; font-size: 0.9rem; }
    </style>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body>

<div class="app-layout">
    <aside class="sidebar">
        <h2>Sources</h2>
        <div id="sources-list">
            {% for source in notebook.sources %}
                <div class="source-item">üìÑ {{ source.title }}</div>
            {% else %}
                <div class="empty">No sources yet.</div>
            {% endfor %}
        </div>

        {% if can_edit %}
            <hr>
            <h3>Add Source</h3>
            <form id="add-source-form">
                <input type="text" id="source-title" placeholder="Title" required>
                <textarea id="source-content" placeholder="Paste text here..." required></textarea>
                <button type="submit">Add Source</button>
            </form>

            <hr>
            <h3>Document (Rich editor)</h3>
            <div id="doc-toolbar">
                <!-- quill toolbar will be auto-created -->
            </div>
            <div id="editor" style="height: 320px; background: white; border: 1px solid #ddd;"></div>
            <div style="display:flex; gap:8px; margin-top:8px;">
                <button id="save-doc">Save Document</button>
                <div id="save-status" style="align-self:center; font-size:0.9rem; color:#555;">Not saved</div>
            </div>

            <hr>
            <h3>Import from URL / PDF / YouTube</h3>
            <form id="add-url-form">
                <input type="text" id="import-url" placeholder="https://example.com/article or https://youtu.be/..." required>
                <input type="text" id="import-title" placeholder="Optional title">
                <button type="submit">Import</button>
                <div id="import-status" style="margin-top:8px; font-size:0.9rem;"></div>
            </form>
        {% else %}
            <div class="login-box">
                <p>Owner Mode</p>
                <form action="/n/{{ notebook.id }}/login" method="POST">
                    <input type="password" name="password" placeholder="Password">
                    <button type="submit">Unlock Edit Access</button>
                </form>
            </div>
        {% endif %}
    </aside>

    <main class="main-content">
        <header>
            <h1>{{ notebook.owner_name }}'s Notebook</h1>
            <div class="toolbar">
                <button onclick="generate('flashcards')">‚ö° Flashcards</button>
                <button onclick="generate('quiz')">üìù Quiz</button>
                <button onclick="generate('slides')">üìä Slides</button>
            </div>
        </header>

        <div id="chat-box">
            {% for chat in notebook.chats %}
                <div class="message {{ chat.role }}">
                    <div class="bubble">{{ chat.message }}</div>
                </div>
            {% endfor %}
        </div>

        <div class="chat-input-area">
            <input type="text" id="user-query" placeholder="Ask questions about your sources...">
            <button onclick="sendQuery()">Send</button>
        </div>
    </main>

    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <span onclick="closeModal()" class="close">&times;</span>
            <h2 id="modal-title">Generated Result</h2>
            <pre id="modal-body"></pre>
        </div>
    </div>
</div>

<script>
    const notebookId = "{{ notebook.id }}";

    // Handle Source Addition
    const sourceForm = document.getElementById('add-source-form');
    if(sourceForm){
        sourceForm.onsubmit = async (e) => {
            e.preventDefault();
            const title = document.getElementById('source-title').value;
            const content = document.getElementById('source-content').value;
            
            await fetch(`/n/${notebookId}/add_source`, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `title=${title}&content=${content}`
            });
            location.reload();
        };
    }
    // Document editor (Quill) -- load and autosave (only if editor exists)
    if (document.getElementById('editor')){
        const quillScript = document.createElement('script');
        quillScript.src = 'https://cdn.quilljs.com/1.3.6/quill.js';
        document.head.appendChild(quillScript);
        quillScript.onload = () => {
        const toolbarOptions = [
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'header': 1 }, { 'header': 2 }],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['blockquote', 'code-block'],
            [{ 'script': 'sub'}, { 'script': 'super' }],
            [{ 'indent': '-1'}, { 'indent': '+1' }],
            [{ 'direction': 'rtl' }],
            [{ 'size': ['small', false, 'large', 'huge'] }],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'font': [] }],
            [{ 'align': [] }],
            ['clean']
        ];

        const quill = new Quill('#editor', { modules: { toolbar: toolbarOptions }, theme: 'snow' });
        let currentDocId = null;
        let isDirty = false;

        async function loadDoc(){
            const res = await fetch(`/n/${notebookId}/doc`);
            const data = await res.json();
            currentDocId = data.doc_id;
            if(data.content){
                quill.clipboard.dangerouslyPasteHTML(data.content);
            }
            document.getElementById('save-status').innerText = 'Loaded';
        }

        quill.on('text-change', () => { isDirty = true; document.getElementById('save-status').innerText = 'Editing...'; });

        async function saveDoc(){
            const content = quill.root.innerHTML;
            const title = null; // could derive from first heading
            const payload = { doc_id: currentDocId, content, title };
            try{
                const res = await fetch(`/n/${notebookId}/doc/save`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if(data.success){
                    currentDocId = data.doc_id;
                    isDirty = false;
                    document.getElementById('save-status').innerText = 'Saved';
                } else {
                    document.getElementById('save-status').innerText = 'Save error: ' + (data.error||'unknown');
                }
            } catch(err){
                document.getElementById('save-status').innerText = 'Save failed: ' + err.message;
            }
        }

        document.getElementById('save-doc').onclick = saveDoc;

        // Autosave every 5s if dirty
        setInterval(()=>{ if(isDirty) saveDoc(); }, 5000);

            loadDoc();
        };
    }

    // Handle Import by URL (HTML / PDF / YouTube)
    const urlForm = document.getElementById('add-url-form');
    if(urlForm){
        urlForm.onsubmit = async (e) => {
            e.preventDefault();
            const url = document.getElementById('import-url').value;
            const title = document.getElementById('import-title').value;
            const status = document.getElementById('import-status');
            if(!url) return alert('URL is required');

            status.innerText = 'Importing... this may take a few seconds';
            try{
                const res = await fetch(`/n/${notebookId}/add_source_by_url`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({url, title})
                });
                const data = await res.json();
                if(data.success){
                    status.innerText = 'Import successful';
                    setTimeout(()=> location.reload(), 600);
                } else {
                    status.innerText = 'Import failed: ' + (data.error || 'unknown');
                }
            } catch(err){
                status.innerText = 'Import error: ' + err.message;
            }
        };
    }

    // Handle Chat
    async function sendQuery() {
        const input = document.getElementById('user-query');
        const text = input.value;
        if(!text) return;

        // Add user message to UI immediately
        addMessage(text, 'user');
        input.value = '';

        const res = await fetch(`/n/${notebookId}/query`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({question: text})
        });
        const data = await res.json();
        addMessage(data.answer, 'ai');
    }

    function addMessage(text, role) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `message ${role}`;
        div.innerHTML = `<div class="bubble">${text}</div>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    // Handle Generation Tools
    async function generate(type) {
        document.getElementById('modal').classList.remove('hidden');
        document.getElementById('modal-body').innerText = "Generating... please wait.";
        document.getElementById('modal-title').innerText = type.toUpperCase();

        const res = await fetch(`/n/${notebookId}/generate/${type}`, {method: 'POST'});
        const data = await res.json();
        document.getElementById('modal-body').innerText = data.result;
    }

    function closeModal() {
        document.getElementById('modal').classList.add('hidden');
    }
</script>

</body>
</html>